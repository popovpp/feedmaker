# feedmaker

Скрипт feedmaker предназначен для считывания информации о комплектах из Excel-файла, получение информации о товарах, входящих в комплект из базы данных, получения изображений компонентов комплекта, формирования главного изображения комплектов и формирования xml-фида, содержащего полную информацию о комплектах, сохранение информации о комплектах в базе данных.
Формат Excel-файла в img_1. Колонка "id категории" должна быть обязательно. Если ее нет, или она имеет иное, чем здесь указано название скрипт прекращает работу. Названия листов, подготовленных к обработке должны содержать слова "комплект" и "готово" в любом сочетании. Имя входного Excel-файла должно быть указано в константе "XLS_FILE".
Скрипт предназначен для запуска в среде jupyter notebook. Разработка велась на версии jupyter 6.0.1 одновременно под Windows и под Linux Mint (особенности выявлены при подключении шрифта: в Linux при подключении шрифта нужно указывать полный путь, это учтено в коде). Перед запуском необходимо проверить наличие требуемых пакетов (см. импорты), при отсутствии недостающие необходимо установить. Порядок установки определяется документацией на пакет. Установка пакета должна производиться в то же виртуальное окружение, в котором будет запусаться скрипт. Версия пакета Pillow должна быть 8.3.1 или выше, иначе выравнивание текстового блока на главном изображении комплекта работать не будет.
Скрипт имеет два режима запуска: DEBUG и PROD. Режим устанавливается в секции констант путем присвоения константе MODE значения одной из констант DEBUG или PROD. Если константе MODE не присвоено ни одно из значений, скрипт завершает работу сообщением об ошибке. Режимы оличаются следующим:
1) в режиме DEBUG catalog/images/ размещается в текущей папке скрипта, а в режиме PROD здесь C:/inetpub/wwwroot/export/ozon/catalog/images/;
2) в режиме DEBUG из входного Excel-файла обрабатывается только один лист с комплектами из входного Excel-файла, а в режиме PROD обрабатываются все листы, удовлетворяющие указанным выше условиям.
Блок констант по сути является параметрами скрипта, изменяя которые можно в определенных пределах менять его поведение. В частности, задавать имена и пути к входному и выходному файлам, задавать параметры подключения в базе данных, параметры главного фото комплекта и т.д.
Порядок запуска:
1) установить курсор в ячейке jupyter, содержащей скрипт (выбрать ячейку со скриптом);
2) одновременно нажать клавиши `ctrl + enter`
По ходу выполнения скрипт выдает информацию логирования с метками времени, по которой можно судить о выполнении тех или иных операций и скорости их выполнения. Успешное выполнение скрипта завершается выводом 'Работа скрипта успешно завершена.'

## Версия 0.3.0

В версии 0.3.0 добавились следующие параметрв:
Размер шрифта, px;
Расстояние между строками, px;
Дина строки, симв;
Максимальное количество записей в фиде. 20000 записей дают фид весом около 100 Мб;
Порог определения цветного фона от 0.0 до 1.0. Цветной фон определяется по отклонению СКО от Среднего по 4-м точкам в углах изображения, отстоящих на 10 px от краев.

В версии 0.3.0 добавились следующие фичи:
1. Фиды разбиваются на части на части, максимальный вес каждого не превышает 100 МБ.
2. В описании артикула 2334309 отфильтрована фраза о скрапбукинге (она не относится к этой позиции) “Скрапбукинг давно стал трендом в рукоделии. Этот вид творчества поможет вам открыть в себе новые таланты и создать уникальные вещи. Сохраните милые сердцу воспоминания в альбоме, сделанном своими руками. Или сотворите для близкого человека трогательную открытку, выразив свои чувства и эмоции. </p> <p>Попробовав заняться скрапбукингом один раз, вы влюбитесь в него навсегда! А мы предложим вам огромный выбор качественных товаров по приятным ценам, например”.
3. В названии слово набор сделано с большой буквы. Пример: Набор: мыльная основа, краситель гелевый, диоксид титана, пластиковая форма.
4. На фото увеличены расстояние между строчками. Определен параметр, с помощью которого можно менять расстояние между строчками
5. На фото добавлена обводка изображения  2 px. Пример http://joxi.ru/vAWBYk0C35v5V2
6. Добавлены шаблоны для главного изображения согласно ТЗ https://docs.google.com/document/d/102fnHdw7GLq3j4JuoJqcE2Z1A4V67n7RxraPbj0rrNg/edit#heading=h.ylf1nbguytyu
7. В описании каждого артикула добавлены теги <br>, чтобы обеспечить раздельно отображение абзацев, фраза “в комплекте ед.” тоже с нового абзаца.
8. Добавлен механизм фильтрации стоп-брендов и стоп-слов. В БД есть 2 таблицы - запрещенные бренды и запрещенные слова. Родион напишет названия этих таблиц. Все формируемые комплекты нужно проверить - если среди брендов включаемых товаров есть запрещенный, то его не нужно включать в фид. Также по стоп-словам - если в названии товара есть запрещенное слово, то комплект с этим товаром также не нужно включать в фид. Слова проверяются по полному вхождению. Если там звездочка "*", то это означает все символы до или после.


## Версия 0.3.1

Изменен алгоритм расчета габаритных размеров комплекта: сумма меньших измерений (без привязки длинна, высота или ширина), остальные значения берем по максимальной величине например, пенал 20х3х2 и альбом 25х15х2. Размер упаковки комплекта 25х15х4.

Павел Попов
07.07.2022 г.